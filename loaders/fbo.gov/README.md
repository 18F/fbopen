# Importing FedBizOpps data into FBOpen using the fbo.gov loader

## To install the loader
* Install Solr. See the README in `/solr-files` .
* `npm install`

## To import FedBizOpps data
After install, first load a full set of data using the one-time/weekly loader. Then you can simply run nightly updates.

### 1. One-time/Weekly full load
1. **`get-fbo-xml.sh`**

	Downloads the full, weekly FBO XML file from ftp://ftp.fbo.gov.
	
	Optional arguments:
	
	`$1` = where to save the downloaded file; default = *./workfiles/FBOFullXML.xml*

2. **`fbo-solrize-big.sh`**

	From the fbo.gov weekly XML data dump, creates a Solr-ingestible XML file.
	
	Optional arguments:

	`$1` = filepath/name 3. of weekly FBO XML file "dump"; default = *./workfiles/FBOFullXML.xml*

 	`$2` = output filepath/name for the "solrized" xml (which will be imported into Solr); default = *./workfiles/listings-solrized.xml*

 	`$3` = output filepath/name of the list of links to the FBO listings that were solrized; default = *./workfiles/listings-links.txt*

 	`$4` = directory into which attachments should be downloaded; default = *./fbo-attachments*


3. **`load-solrized.sh`**

	Loads the Solr-ingestible XML file into Solr.
	
	Optional arguments:

	`$1` output xml from step 2; default = *./workfiles/listings-solrized.xml*

4. **`process-listing-links.sh < workfiles/listings-links.txt`** *(or alternate filename of list of links generated by step 2)*

	Downloads and loads into Solr the relevant attachments from each URL in the input stream. Assumes those URLs are fbo.gov listing pages.
	
	**NOTE 1:** This process is currently very slow, as it's completely synchronous. This is intentional; trying to download too many files at once, and trying to load too many into Solr at once, led to problems. Better would be (1) a throttled async version that handles several file downloads simultaneously, and (2) Do the Solr ingestion in a completely separate step.
	
	**NOTE 2:** It's also very buggy. There are many files that shouldn't be downloaded but are, and there are many files that are behind multiple clicks and/or unreachable without login. The algorithm for doing these downloads will have to improve significantly.
	
### Nightly updates
* To download the nightly data file: `node nightly-fbo-parser.js -o [-d YYYYMMDD]` (defaults to yesterday)
* To load the nightly data into FBOpen: `node nightly-fbo-parser.js [-d YYYYMMDD]` (defaults to yesterday)
* To collect and load listings' attachments into FBOpen: `process-listing-links.sh < links-YYYYMMDD.txt`

The core of the nightly parser code is borrowed wholesale from our predecessor [Adam Becker's](https://github.com/adamjacobbecker/) [fbo-parser](https://github.com/presidential-innovation-fellows/fbo-parser). Thanks Adam!
