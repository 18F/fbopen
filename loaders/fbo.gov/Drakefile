ELASTICSEARCH_URI:="localhost:9200/_bulk"

; download the nightly file
nightly.txt <-
	wget -O $OUTPUT ftp://ftp.fbo.gov/FBOFeed$[DOWNLOAD_DATE]

; process the nightly file and extract links
notices.json <- nightly.txt
    cat $INPUT | node xml2json.js > $OUTPUT

; ingest the metadata if not ingested already
notices_preprocessed.json <- notices.json
	cat $INPUT | node process_notices.js > $OUTPUT

nightly_links.txt <- notices_preprocessed.json
    cat $INPUT | json -ga listing_url > $OUTPUT

; process notices into ES's bulk format
notices_es.bulk <- notices_preprocessed.json
    cat $INPUT | node ../common/format-bulk.js > $OUTPUT

; load into ES
$[ELASTICSEARCH_URI] <- notices_es.bulk
    curl -s -XPOST $OUTPUT --data-binary @$INPUT; echo

